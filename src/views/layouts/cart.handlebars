<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<header>
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <ul class="nav nav-pills ms-auto mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active " id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home"  type="button" role="tab" aria-controls="pills-home" aria-selected="true" href="/">Home</a>
                    </li>

                    <li class="nav-item hover" role="presentation">
                        <a class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" href="/profile" aria-selected="false">Mi perfil</a>
                    </li>

                    <li class="nav-item hover" role="presentation">
                        <a class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" href="/productlist" aria-selected="false">Productos</a>
                    </li>

                    <li class="nav-item hover" role="presentation">
                        <a class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" href="/api/sessions/logout" aria-selected="false">Cerrar sesión</a>
                    </li>
                </ul>
            </div>
        </nav> 
    </header>
<body>
    <h1 class="mt-5">Carrito de Compras:</h1>
    <div class="container mt-3">
        <div class="row">
            <div class="col-md-12">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Producto</th>
                            <th scope="col">Cantidad</th>
                            <th scope="col">Precio Unitario</th>
                            <th scope="col">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each cart.products}}
                        <tr>
                            <td>{{this.product.title}}</td>
                            <td>{{this.quantity}}</td>
                            <td>{{this.product.price}}</td>
                            <td>{{multiply this.product.price this.quantity}}</td>
                            <td>
                                <button class="btn btn-success" onclick="editarProducto('{{this.product.id}}')">Editar</button>
                                <button class="btn btn-danger"onclick="eliminarProducto('{{this.product.id}}')">Eliminar</button>
                                <button class="btn btn-danger" onclick="eliminarProducto('{{cartId}}', '{{this._id}}')">Eliminar P</button>
                            </td>
                            
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
                <div class="text-center">
                    <h3>Total: {{cart.total}}</h3>
                    <a href="/checkout" class="btn btn-primary">Proceder al Pago</a>
                    <button class="btn btn-danger" onclick="vaciarCarrito ("{{this.cart.id}}")">Vaciar Carrito</button>
                </div>
            </div>
        </div>
    </div>
        <script>
        async function eliminarProducto(cartId, productId) {
        try {
            const response = await fetch(`/api/cart/${cartId}/product/${productId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                // Actualiza la tabla o recarga la página para reflejar los cambios
                location.reload();
            } else {
                const errorData = await response.json();
                console.error('Error al eliminar el producto del carrito:', errorData.message);
                alert('Error al eliminar el producto del carrito: ' + errorData.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar el producto del carrito');
        }
    }
    </script>
</body>
</html>